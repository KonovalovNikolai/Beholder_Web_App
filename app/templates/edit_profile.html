{% extends "base.html" %}

{% block styles %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.4.1/cropper.css" rel="stylesheet">
{% endblock %}

{% block content %}
    <h1>{{ user.get_fullname() }}: Редактирование профиля.</h1>
    <img src="{{ url_for('avatar', filename=user.get_avatar_name()) }}" alt="User avatar" id="avatar">

    <p>Личная информация.</p>
    <form action="" method="POST">
        {{ profile_form.hidden_tag() }}
        <p>
            {{ profile_form.email.label }}<br>
            {{ profile_form.email(size=32) }}<br>
            {% for error in profile_form.email.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </p>
        <p>
            {{ profile_form.firstname.label }}<br>
            {{ profile_form.firstname(size=32) }}<br>
        </p>
        <p>
            {{ profile_form.lastname.label }}<br>
            {{ profile_form.lastname(size=32) }}<br>
        </p>
        <p>
            {{ profile_form.patronymic.label }}<br>
            {{ profile_form.patronymic(size=32) }}<br>
        </p>
        <p><input type="submit" name="{{profile_form.form_name}}" value="Редактировать"></p>
    </form>

    <p>Изменить пароль</p>
    <form action="" method="POST">
        {{password_form.hidden_tag()}}
        <p>
            {{ password_form.old_password.label }}<br>
            {{ password_form.old_password(size=32) }}<br>
            {% for error in password_form.old_password.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </p>
        <p>
            {{ password_form.new_password.label }}<br>
            {{ password_form.new_password(size=32) }}<br>
            {% for error in password_form.new_password.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </p>
        <p>
            {{ password_form.repeated_password.label }}<br>
            {{ password_form.repeated_password(size=32) }}<br>
            {% for error in password_form.repeated_password.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </p>
        <p><input type="submit" name="{{password_form.form_name}}" value="Изменить пароль"></p>
    </form>

    <p>Изменить фото.</p>
    <div>
        <input type="file" id="cropperfile" />
        <div style="width:600px;height:400px;">
            <img src="" id="cropper-img" />
        </div>
        <button id="crop">Загрузить</button>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.4.1/cropper.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/cropper.js') }}"></script>
    <script>
    $("#crop").click(function(){
        $(this).attr('disabled','disabled');
        if (cropper == '') {
            alert('Загрузить фото');
            return false;
        }

        canvas = cropper.getCroppedCanvas({
          width: 250,
          height: 250,
        });

        canvas.toBlob(function(blob) {
            var reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {

                var url = '{{ url_for('upload_avatar', user_id=user.id) }}';
                var data = new FormData();

                blob = reader.result;
                data.append("blob", blob);

                $.ajax({
                    url: url,
                    type: 'POST',
                    cache: false,
                    data: data,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if(response["result"] == "Done"){
                            alert('Фото загружено');
                            document.location.reload();
                        }
                        else{
                            alert('Произошла ошибка');
                            $("#crop").removeAttr('disabled');
                        }
                    },
                    error: function(response) {
                        console.log(response);
                        $("#crop").removeAttr('disabled');
                    }
                })
            }
        })
    });
    </script>
{% endblock %}
