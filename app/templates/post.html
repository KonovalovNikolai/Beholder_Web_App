{% extends "base.html" %}

{% block styles %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/details_table.css') }}">
{% endblock %}

{% block content %}
    {% include '_post_header.html' %}
    <div>
        <h2>Аудитория: {{ post.room }},</h2>
        <h2>Занятие: {{ post.lesson }}.</h2>
        <h2>Заметка: {{ post.notes }}</h2>
    </div>

    {% if current_user.is_student() %}
        {% if post.check_student(current_user.id) %}
            {# Студент был отмечен - зелённое окно #}
            <div>
                <h2>Вас отметили.</h2>
            </div>
        {% elif current_user.check_request(post.id) %}
            {# Студент уже отправил запрос - серое окно #}
            <div>
                <h2>Вы уже отправили запрос.</h2>
                <button id="cancel-request" class="request-button" data-id="{{ current_user.id }}" data-url="{{ url_for('cancel_request', post_id=post.id) }}">
                    Отменить
                </button>
            </div>
        {% else %}
            {# Студент не был отмечен - красное окно #}
            <div>
                <h2>Вы не были отмечены.</h2>
                <button id="send-request" class="request-button" data-id="{{ current_user.id }}" data-url="{{ url_for('take_request', post_id=post.id) }}">
                    Попросить отметить
                </button>
            </div>
        {% endif %}
    {% endif %}

    <details open="">
        <summary>Отмеченные студенты</summary>
        <table>
            <thead>
            <tr align="center">
                <th>Фото</th>
                <th>ФИО</th>
                <th>Точность</th>
                <th>Подтверждён</th>
            </tr>
            </thead>
            {% for visitor in post.get_visitors() %}
                <tr align="center" user_id="visitor.">
                    <td><img src="{{ url_for('avatar', filename=visitor.student.user.get_avatar_name()) }}" width="50">
                    </td>
                    <td>{{ visitor.student.user.get_fullname() }}</td>
                    <td>{{ visitor.get_distance() }}</td>
                    {% if visitor.lecturer_proved == 0 %}
                        <td>&#9746;</td>
                        {% if current_user.is_can_edit(post) %}
                            <td>
                                <button>Подтвердить</button>
                            </td>
                        {% endif %}
                    {% else %}
                        <td>&#9745;</td>
                    {% endif %}
                </tr>
            {% endfor %}
        </table>
    </details>

    <details>
        <summary>Просят отметить</summary>
        <table></table>
    </details>

    <p>Экспортировать запись в Exel</p>

{% endblock %}

{% block scripts %}
    <script>
        if ($('.request-button').length !== 0) {
            $('.request-button').click(function () {
                $(this).attr('disabled', 'disabled');

                var url = $(this).data('url');

                var data = new FormData();
                data.append('id', $(this).data('id'));

                $.ajax({
                    url: url,
                    type: 'POST',
                    cache: false,
                    data: data,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        document.location.reload();
                    },
                    error: function (response) {
                        alert('Что-то пошло не так.\nПопробуйте ещё раз позже.');
                    }
                });
            });
        }
    </script>
{% endblock %}